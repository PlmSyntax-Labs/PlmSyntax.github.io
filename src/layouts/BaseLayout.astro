---
import SEO from '@components/common/SEO.astro';
import { modules } from '@/config';
import '../styles/global.css';

interface Props {
  title: string;
  description: string;
  image?: string;
  type?: 'website' | 'article';
  // Article-specific props for JSON-LD
  publishedDate?: Date;
  modifiedDate?: Date;
  author?: string;
  tags?: string[];
}

const {
  title,
  description,
  image,
  type = 'website',
  publishedDate,
  modifiedDate,
  author,
  tags,
} = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <SEO
      title={title}
      description={description}
      image={image}
      type={type}
      publishedDate={publishedDate}
      modifiedDate={modifiedDate}
      author={author}
      tags={tags}
    />
    <!-- Theme and announcement initialization - runs before page render to prevent flash -->
    <script is:inline>
      (function () {
        // Theme initialization
        const stored = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = stored || (prefersDark ? 'dark' : 'light');
        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
        }

        // Announcement dismissal check - hide if any announcement was dismissed
        const keys = Object.keys(localStorage).filter((k) =>
          k.startsWith('announcement-dismissed-')
        );
        keys.forEach((key) => {
          if (localStorage.getItem(key) === 'true') {
            const id = key.replace('announcement-dismissed-', '');
            document.documentElement.classList.add(`announcement-${id}-dismissed`);
          }
        });
      })();
    </script>
  </head>
  <body class="min-h-screen bg-background text-text antialiased">
    <!-- Skip to main content link for accessibility -->
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-[100] focus:px-4 focus:py-2 focus:bg-primary focus:text-white focus:rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
    >
      Skip to main content
    </a>
    <slot />

    <!-- Waitlist Modal -->
    <div id="waitlist-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm">
      <div class="relative bg-background border border-border rounded-lg shadow-2xl max-w-md w-full mx-4 p-8">
        <button id="waitlist-close" type="button" class="absolute top-4 right-4 text-text-muted hover:text-text transition-colors cursor-pointer">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
        <h3 class="text-2xl font-bold text-text">Secure Your Early Bird Spot</h3>
        <p class="mt-3 text-text-muted text-sm leading-relaxed">
          PlmSyntax is currently in final QA. We are accepting a limited number of early adopters for our Q3 2026 launch. Enter your email to secure a <strong class="text-primary">50% launch discount</strong> and get notified the moment we go live.
        </p>
        <form id="waitlist-form" class="mt-6 space-y-4">
          <div>
            <label for="waitlist-email" class="block text-sm font-medium text-text mb-1">Work Email</label>
            <input
              type="email"
              id="waitlist-email"
              name="email"
              required
              placeholder="you@company.com"
              class="w-full px-4 py-2.5 rounded-md border border-border bg-surface text-text placeholder:text-text-muted/60 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
            />
          </div>
          <div>
            <label for="waitlist-module" class="block text-sm font-medium text-text mb-1">Interested in</label>
            <select
              id="waitlist-module"
              name="module"
              class="w-full px-4 py-2.5 rounded-md border border-border bg-surface text-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
            >
              {modules.map((module) => (
                <option value={module.id}>{module.label}</option>
              ))}
            </select>
          </div>
          <div>
            <label for="waitlist-company" class="block text-sm font-medium text-text mb-1">Company (optional)</label>
            <input
              type="text"
              id="waitlist-company"
              name="company"
              placeholder="Acme Engineering"
              class="w-full px-4 py-2.5 rounded-md border border-border bg-surface text-text placeholder:text-text-muted/60 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
            />
          </div>
          <button
            type="submit"
            class="w-full px-6 py-3 rounded-md bg-primary text-white font-medium hover:bg-primary-dark transition-colors cursor-pointer"
          >
            Reserve My 50% Discount
          </button>
          <p class="text-xs text-text-muted text-center">No spam. Unsubscribe anytime. We respect your privacy.</p>
        </form>
      </div>
    </div>

    <script>
      function initWaitlistModal() {
        const modal = document.getElementById('waitlist-modal');
        const closeBtn = document.getElementById('waitlist-close');
        const form = document.getElementById('waitlist-form');

        // Open modal on any #waitlist link click
        document.querySelectorAll('a[href*="#waitlist"]').forEach((link) => {
          link.addEventListener('click', (e) => {
            // Only prevent default if it's strictly a trigger on the same page
            if (location.pathname === (link as HTMLAnchorElement).pathname || (link as HTMLAnchorElement).pathname === '') {
              e.preventDefault();
            }
            modal?.classList.remove('hidden');
            modal?.classList.add('flex');
          });
        });

        // Close modal
        function closeModal() {
          modal?.classList.add('hidden');
          modal?.classList.remove('flex');
        }

        closeBtn?.addEventListener('click', closeModal);
        modal?.addEventListener('click', (e) => {
          if (e.target === modal) closeModal();
        });
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') closeModal();
        });

        // Form submit - send to Google Forms, then show success
        form?.addEventListener('submit', (e) => {
          e.preventDefault();
          const email = (document.getElementById('waitlist-email') as HTMLInputElement)?.value;
          const company = (document.getElementById('waitlist-company') as HTMLInputElement)?.value;
          const module = (document.getElementById('waitlist-module') as HTMLSelectElement)?.value;

          const googleFormUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSceruEk5bdlwXLXVf6wKnUeByspX69VZTV-hWgcY_RpMSgKxg/formResponse';
          const params = new URLSearchParams();
          params.append('entry.361515637', email);
          
          // Combine company and module with a divider
          const companyWithModule = company ? `${company} | Module: ${module}` : `Module: ${module}`;
          params.append('entry.1585641090', companyWithModule);

          // Submit silently
          fetch(googleFormUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params.toString(),
          }).finally(() => {
            window.location.href = '/thanks';
          });
        });
      }

      initWaitlistModal();
      document.addEventListener('astro:page-load', initWaitlistModal);
    </script>

    <!-- Analytics: silent tracking via Google Forms -->
    <script is:inline>
      (function () {
        var startTime = Date.now();
        var maxScroll = 0;
        var sectionsViewed = {};
        var clicks = [];
        var sent = false;

        // Track scroll depth
        window.addEventListener('scroll', function () {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop;
          var docHeight = document.documentElement.scrollHeight - window.innerHeight;
          var pct = docHeight > 0 ? Math.round((scrollTop / docHeight) * 100) : 0;
          if (pct > maxScroll) maxScroll = pct;
        });

        // Track sections entering viewport
        if (window.IntersectionObserver) {
          var observer = new IntersectionObserver(function (entries) {
            entries.forEach(function (e) {
              if (e.isIntersecting) {
                var id = e.target.id || e.target.querySelector('h2,h3')?.textContent?.trim().substring(0, 40) || 'unknown';
                sectionsViewed[id] = true;
              }
            });
          }, { threshold: 0.3 });
          document.querySelectorAll('section').forEach(function (s) { observer.observe(s); });
        }

        // Track clicks on links and buttons
        document.addEventListener('click', function (e) {
          var el = e.target.closest('a,button');
          if (el && clicks.length < 20) {
            clicks.push(el.textContent.trim().substring(0, 30));
          }
        });

        // Send data when user leaves
        function sendAnalytics() {
          if (sent) return;
          sent = true;
          var params = new URLSearchParams();
          params.append('entry.1828254785', location.pathname);
          params.append('entry.1647285148', document.referrer || 'direct');
          params.append('entry.1398373838', screen.width + 'x' + screen.height);
          params.append('entry.1874351611', Math.round((Date.now() - startTime) / 1000) + 's');
          params.append('entry.405780363', maxScroll + '%');
          params.append('entry.1970008169', Object.keys(sectionsViewed).join(', '));
          params.append('entry.1184740145', clicks.join(', '));
          fetch('https://docs.google.com/forms/d/e/1FAIpQLSfh9BRlZR2Y9d3XBzmSgE1-B1-BwEt9efRI0aIvBbGOEeCQBg/formResponse', {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params.toString(),
          });
        }

        document.addEventListener('visibilitychange', function () {
          if (document.visibilityState === 'hidden') sendAnalytics();
        });
        window.addEventListener('beforeunload', sendAnalytics);
      })();
    </script>
  </body>
</html>
