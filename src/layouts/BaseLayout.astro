---
import SEO from '@components/common/SEO.astro';
import '../styles/global.css';

interface Props {
  title: string;
  description: string;
  image?: string;
  type?: 'website' | 'article';
  // Article-specific props for JSON-LD
  publishedDate?: Date;
  modifiedDate?: Date;
  author?: string;
  tags?: string[];
}

const {
  title,
  description,
  image,
  type = 'website',
  publishedDate,
  modifiedDate,
  author,
  tags,
} = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <SEO
      title={title}
      description={description}
      image={image}
      type={type}
      publishedDate={publishedDate}
      modifiedDate={modifiedDate}
      author={author}
      tags={tags}
    />
    <!-- Theme and announcement initialization - runs before page render to prevent flash -->
    <script is:inline>
      (function () {
        // Theme initialization
        const stored = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = stored || (prefersDark ? 'dark' : 'light');
        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
        }

        // Announcement dismissal check - hide if any announcement was dismissed
        const keys = Object.keys(localStorage).filter((k) =>
          k.startsWith('announcement-dismissed-')
        );
        keys.forEach((key) => {
          if (localStorage.getItem(key) === 'true') {
            const id = key.replace('announcement-dismissed-', '');
            document.documentElement.classList.add(`announcement-${id}-dismissed`);
          }
        });
      })();
    </script>
  </head>
  <body class="min-h-screen bg-background text-text antialiased">
    <!-- Skip to main content link for accessibility -->
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-[100] focus:px-4 focus:py-2 focus:bg-primary focus:text-white focus:rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
    >
      Skip to main content
    </a>
    <slot />

    <!-- Analytics: silent tracking via Google Forms -->
    <script is:inline>
      (function () {
        var startTime = Date.now();
        var maxScroll = 0;
        var sectionsViewed = {};
        var clicks = [];
        var sent = false;

        // Track scroll depth
        window.addEventListener('scroll', function () {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop;
          var docHeight = document.documentElement.scrollHeight - window.innerHeight;
          var pct = docHeight > 0 ? Math.round((scrollTop / docHeight) * 100) : 0;
          if (pct > maxScroll) maxScroll = pct;
        });

        // Track sections entering viewport
        if (window.IntersectionObserver) {
          var observer = new IntersectionObserver(function (entries) {
            entries.forEach(function (e) {
              if (e.isIntersecting) {
                var id = e.target.id || e.target.querySelector('h2,h3')?.textContent?.trim().substring(0, 40) || 'unknown';
                sectionsViewed[id] = true;
              }
            });
          }, { threshold: 0.3 });
          document.querySelectorAll('section').forEach(function (s) { observer.observe(s); });
        }

        // Track clicks on links and buttons
        document.addEventListener('click', function (e) {
          var el = e.target.closest('a,button');
          if (el && clicks.length < 20) {
            clicks.push(el.textContent.trim().substring(0, 30));
          }
        });

        // Send data when user leaves
        function sendAnalytics() {
          if (sent) return;
          sent = true;
          var params = new URLSearchParams();
          params.append('entry.1057425198', location.pathname);
          params.append('entry.777714297', document.referrer || 'direct');
          params.append('entry.1632853858', screen.width + 'x' + screen.height);
          params.append('entry.463683274', Math.round((Date.now() - startTime) / 1000) + 's');
          params.append('entry.2048956033', maxScroll + '%');
          params.append('entry.1763541546', Object.keys(sectionsViewed).join(', '));
          params.append('entry.575501768', clicks.join(', '));
          navigator.sendBeacon(
            'https://docs.google.com/forms/d/e/1FAIpQLSfh9BRlZR2Y9d3XBzmSgE1-B1-BwEt9efRI0aIvBbGOEeCQBg/formResponse',
            params
          );
        }

        document.addEventListener('visibilitychange', function () {
          if (document.visibilityState === 'hidden') sendAnalytics();
        });
        window.addEventListener('beforeunload', sendAnalytics);
      })();
    </script>
  </body>
</html>
